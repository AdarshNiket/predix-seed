<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="px-deck.html">

<dom-module id="px-deck-index">

  <template>

    <iron-ajax
      id="deckIronAjax"
      url="[[_deckUrl]]"
      last-response="{{_deckData}}"
      auto>
    </iron-ajax>

    <template id="decks" is="dom-repeat" items="{{_decks}}" filter="_filterDecks">
      <px-deck id="[[item.id]]" deck-data="[[item.deckData]]"></px-deck>
    </template>

  </template>

  <!-- include lodash utility library -->
  <script src="../../bower_components/lodash/dist/lodash.min.js"></script>

  <script>
    Polymer({

      is: 'px-deck-index',

      properties: {
        deckId: {
          type: String
        },
        // returned from iron-ajax request
        _deckData: {
          type: Object,
          value: function() { return {}; },
          observer: '_refreshFilter'
        },
        viewServiceBaseUrl: {
          type: String,
          value: '/api/view-service/' // default
        },
        // updated when deckId is changed
        _deckUrl: {
          type: String,
          computed: '_computeDeckUrl(deckId)'
        },
        _decks: {
          type: Array,
          value: function() { return []; }
        }
      },

      observers: [
        '_updateDecks(_deckData)'
      ],

      _computeDeckUrl: function() {
        return this.viewServiceBaseUrl + 'decks/' + this.deckId;
      },

      _deckIsVisible: function(deckId) {
        return this.deckId === deckId;
      },

      _filterDecks: function(deck) {
        return this._deckIsVisible(deck.id);
      },

      _refreshFilter: function() {
        this.$.decks.render();
      },

      _updateDecks: function() {
        if(this._decks) {
          // find existing deck
          var that = this;
          var index = _.findIndex(this._decks, function(o) {
            return o.id === that.deckId
          });
          if(index === -1) {
            // deck is new
            this.push('_decks', {
              id: this.deckId,
              deckData: this._deckData
            });
          } else {
            // update existing deck data
            this._decks[index].deckData = this._deckData;
          }
        }
      }

    });
  </script>

</dom-module>
