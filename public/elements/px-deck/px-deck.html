<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">

<dom-module id="px-deck">

  <template>
    <iron-ajax
      id="deckIronAjax"
      url="[[_deckUrl]]"
      last-response="{{_deckData}}"
      auto>
    </iron-ajax>
    <div id="cardViews">
      <!-- px-view elements for cards inserted here -->
    </div>
  </template>

  <!-- include lodash utility library -->
  <script src="/bower_components/lodash/dist/lodash.min.js"></script>

  <script>
    Polymer({

      is: 'px-deck',

      properties: {
        // set by parent
        deckId: {
          type: String
        },
        viewServiceBaseUrl: {
          type: String,
          value: '/api/view-service/' // default
        },
        // set on initialzation
        _decksUrl: {
          type: String,
          computed: '_computeDecksUrl(viewServiceBaseUrl)'
        },
        // updated when deckId is changed
        _deckUrl: {
          type: String,
          computed: '_computeDeckUrl(_decksUrl, deckId)'
        },
        // returned from iron-ajax request
        _deckData: {
          type: Object,
          value: function() { return {}; }
        },
        // cards: [{card},{card}] updated on _deckData change
        _cards: {
          type: Array,
          value: function() { return []; },
          observer: '_updateCardViews'
        }
      },

      observers: [
        '_setCards(_deckData)'
      ],

      _computeDeckUrl: function() {
        // Set Url of iron-ajax element, triggering request and update of _lastDeck
        return this._decksUrl + this.deckId;
      },

      _computeDecksUrl: function() {
        return this.viewServiceBaseUrl + 'decks/';
      },

      _setCards: function() {
        if(typeof this._deckData !== 'undefined') {
          var cards = this._deckData.cards || [];
          this.set('_cards', cards);
        }
      },

      _updateCardViews: function() {
        // first remove child nodes
        var that = this;
        var cardViews = Polymer.dom(this.$.cardViews);
        _.each(cardViews.childNodes, function(cardViewNode) {
          cardViews.removeChild(cardViewNode);
        });
        // attach card views
        _.each(this._cards, function(card) {
          // create view element
          var view = document.createElement('px-view');
          // set view element attributes
          view.setAttribute('id', 'px-view-' + new Date().getTime());
          view.setAttribute('active', 'true');
          view.setAttribute('element-href', card.attributes.elementHref);
          view.setAttribute('element-data', JSON.stringify(card));
          // append view element to DOM
          Polymer.dom(that.$.cardViews).appendChild(view);
        });
      }

    });
  </script>
</dom-module>
