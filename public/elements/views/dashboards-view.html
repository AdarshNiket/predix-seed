<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/px-context-browser/px-context-browser.html">
<link rel="import" href="../../bower_components/px-deck-selector/px-deck-selector.html">
<link rel="import" href="../../bower_components/px-card/px-dashboard.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<!-- this element loads another element and appends it to #element -->
<dom-module id="dashboards-view">
  <template>
    <script src="../../bower_components/lodash/lodash.js"></script>
    <script src="../../bower_components/q/q.js"></script>
    <!--
    <px-context-browser
      api-url="http://localhost:8181/api"
      root-uri="/root">
    </px-context-browser>
    <px-dashboard
      view-service-base-url="{{viewServiceBaseUrl}}"
      selected-deck-id="{{selectedDeck.id}}"
      context="{{context}}"></px-dashboard>
    -->
    <iron-ajax id="contextIronAjax"
      url="http://localhost:8181/api/predix-asset/root"
      last-response="{{browserContext}}" auto></iron-ajax>
    <iron-ajax id="decksIronAjax"
      url="http://localhost:8181/api/view-service/decks"
      last-response="{{decksResponse}}" auto></iron-ajax>
    <iron-ajax id="deckIronAjax"
      last-response="{{deck}}" auto></iron-ajax>
      DECK: [[_deckString]]
    <px-context-browser
      id="contextBrowser"
      label-field="name"
      id-field="id"
      browser-context="{{browserContext}}"
      show-chevron="true">
      <px-deck-selector decks="[[_decks]]" selected-deck="{{selectedDeck}}"></px-deck-selector>
    </px-context-browser>
  </template>
  <script>
    Polymer({

      is: 'dashboards-view',

      properties: {
        _deckString: {
          type: String,
          computed: '_computeDeckString(deck)'
        },
        _decks: {
          type: Array,
          computed: '_computeDecks(decksResponse)'
        }
      },

      ready: function ready() {
        var _this = this;
        var colBrowser = this.$.contextBrowser;
        colBrowser.handlers = {
          getChildren: function(parent, newIndex) {
            return _this._getChildren(parent);
          },
          itemOpenHandler: function(context) {
            return _this._itemOpenHandler(context);
          }
        };
      },

      _computeDecks(decksResponse) {
        var decks = [];
        if (decksResponse && decksResponse.length > 0) {
          decksResponse.forEach(function(deck) {
            decks.push({ name: deck.title, id: deck.id });
          });
        };
        return decks;
      },

      _computeDeckString: function() {
        return JSON.stringify(this.deck);
      },

      // "getChildren" handler for px-context-browser
      _getChildren: function(node) {
        var nodeId = node.id,
            nodeUri = node.uri,
            deferred = Q.defer(),
            children,
            response,
            ironAjaxEl = document.createElement('iron-ajax');

        ironAjaxEl.handleAs = "json";
        ironAjaxEl.addEventListener('response', function(evt) {
          if(evt.detail.response) {
            children = evt.detail.response;
            deferred.resolve(children);
          } else {
            return;
          }
        });

        //get our url - if there's no valid nodeId, resolve an empty promise.
        if (nodeUri) {
          ironAjaxEl.url = 'http://localhost:8181/api/predix-asset' + nodeUri;
          // and generate the promise
          ironAjaxEl.generateRequest();
        } else {
          deferred.resolve({ data: [], meta: { parentId: nodeId } });
        }

        //don't forget to return the promise!
        return deferred.promise;
      },

      _itemOpenHandler: function(item) {
        // mapping of tags to deckId values
        var tags = [
          { 'tag': 'predix-energy', 'deckId': '1' },
          { 'tag': 'richmond', 'deckId': '2' },
          { 'tag': 'richmond-refinery', 'deckId': '3' },
          { 'tag': 'compressor-2015', 'deckId': '4' }
        ];
        var tag = _.find(tags, function(o) { return o.tag === item.id; });
        this.$.deckIronAjax.url = 'http://localhost:8181/api/view-service/decks/' + tag.deckId;
        console.log('this.$.deckIronAjax: ', this.$.deckIronAjax);
        /*
        this._getDeck(tag.deckId).then(function(deck) {
          console.log('_getDeck complete: ', deck);
        }, function(e) {
          console.log(e);
        });
        */
      },

      _getDecks: function() {

      },

      // returns a promise
      _getDeck: function(id) {
        var deferred = Q.defer();
        var ironAjaxEl = this.$.deckIronAjax;
        ironAjaxEl.addEventListener('response', function(e) {
          if(e.detail.response) {
            deferred.resolve(e.detail.response);
          } else {
            return;
          }
        });
        if(id) {
          ironAjaxEl.url = 'http://localhost:8181/api/view-service/decks/' + id;

          ironAjaxEl.generateRequest();
        } else {
          deferred.resolve({});
        };
        return deferred.promise;
      }

    });
  </script>
</dom-module>
