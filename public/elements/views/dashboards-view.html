<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/px-context-browser/px-context-browser.html">
<link rel="import" href="../../bower_components/px-deck-selector/px-deck-selector.html">
<link rel="import" href="../../bower_components/px-card/px-dashboard.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<!-- this element loads another element and appends it to #element -->
<dom-module id="dashboards-view">
  <template>
    <script src="../../bower_components/lodash/lodash.js"></script>
    <script src="../../bower_components/q/q.js"></script>
    <!--
    <px-context-browser
      api-url="http://localhost:8181/api"
      root-uri="/root">
    </px-context-browser>
    <px-dashboard
      view-service-base-url="{{viewServiceBaseUrl}}"
      selected-deck-id="{{selectedDeck.id}}"
      context="{{context}}"></px-dashboard>
    -->
    <iron-ajax id="contextIronAjax"
      url="http://localhost:8181/api/predix-asset/root"
      last-response="{{_browserContext}}" auto></iron-ajax>
    <iron-ajax id="decksIronAjax"
      url="http://localhost:8181/api/view-service/decks"
      last-response="{{decksResponse}}" auto></iron-ajax>
    <iron-ajax id="deckIronAjax"
      last-response="{{deck}}" auto></iron-ajax>
    <px-context-browser
      id="contextBrowser"
      label-field="name"
      id-field="id"
      browser-context="[[_initialBrowserContext]]"
      show-chevron="true">
      <px-deck-selector decks="[[_decks]]" selected-deck="{{selectedDeck}}"></px-deck-selector>
    </px-context-browser>
  </template>
  <script>
    Polymer({

      is: 'dashboards-view',

      properties: {
        _decks: {
          type: Array,
          computed: '_computeDecks(decksResponse)'
        },
        _initialBrowserContext: {
          type: Object,
          computed: '_computeInitialBrowserContext(_browserContext)'
        }
      },

      ready: function ready() {
        var _this = this;
        var colBrowser = this.$.contextBrowser;
        colBrowser.handlers = {
          getChildren: function(parent, newIndex) {
            return _this._getChildren(parent);
          },
          itemOpenHandler: function(context) {
            return _this._itemOpenHandler(context);
          }
        };
      },

      _computeDecks: function(decksResponse) {
        var decks = [];
        if (decksResponse && decksResponse.length > 0) {
          decksResponse.forEach(function(deck) {
            decks.push({ name: deck.title, id: deck.id });
          });
        };
        return decks;
      },

      _computeInitialBrowserContext: function(_browserContext) {
        if(typeof this._initialBrowserContext !== 'object') {
          return _browserContext;
        } else {
          return this._initialBrowserContext;
        }

      },

      // "getChildren" handler for px-context-browser
      _getChildren: function(node) {
        var nodeUri = node.uri,
            deferred = Q.defer(),
            children,
            response,
            ironAjaxEl = document.createElement('iron-ajax');

        this.$.contextIronAjax.url = 'http://localhost:8181/api/predix-asset' + nodeUri;

        this.$.contextIronAjax.addEventListener('response', function(evt) {
          if(evt.detail.response) {
            children = evt.detail.response;
            deferred.resolve(children);
          } else {
            return;
          }
        });
        //don't forget to return the promise!
        return deferred.promise;
      },

      _itemOpenHandler: function(item) {
        // mapping of tags to deckId values
        var tags = [
          { 'tag': 'predix-energy', 'deckId': '1' },
          { 'tag': 'richmond', 'deckId': '2' },
          { 'tag': 'richmond-refinery', 'deckId': '3' },
          { 'tag': 'compressor-2015', 'deckId': '4' }
        ];
        var tag = _.find(tags, function(o) { return o.tag === item.id; });
        this.$.deckIronAjax.url = 'http://localhost:8181/api/view-service/decks/' + tag.deckId;
      }

    });
  </script>
</dom-module>
