<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/px-context-browser/px-context-browser.html">
<link rel="import" href="../../bower_components/px-deck-selector/px-deck-selector.html">
<link rel="import" href="../../bower_components/px-card/px-dashboard.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<!-- this element loads another element and appends it to #element -->
<dom-module id="dashboards-view">
  <template>
    <script src="../../bower_components/q/q.js"></script>
    <!--
    <px-context-browser
      api-url="http://localhost:8181/api"
      root-uri="/root">
    </px-context-browser>
    -->
    <!--
    <px-dashboard
      view-service-base-url="{{viewServiceBaseUrl}}"
      selected-deck-id="{{selectedDeck.id}}"
      context="{{context}}"></px-dashboard>
    -->
    <iron-ajax id="contextIronAjax" url="http://localhost:8181/api/root" last-response="{{browserContext}}" auto></iron-ajax>
    <px-context-browser
      id="contextBrowser"
      label-field="name"
      id-field="identifier"
      browser-context="{{browserContext}}"
      show-chevron="true">
    </px-context-browser>
  </template>
  <script>
    Polymer({

      is: 'dashboards-view',

      properties: {},

      ready: function ready() {
        var _this = this;
        var colBrowser = this.$.contextBrowser;
        colBrowser.handlers = {
          getChildren: function(parent, newIndex) {
            return _this._getChildren(parent);
          },
          itemOpenHandler: function(context) {
            return _this._itemOpenHandler(context);
          }
        };
      },

      _itemOpenHandler: function(context) {
        console.log('Opened: ', context);
      },

      // "getChildren" handler for px-context-browser
      _getChildren: function(node) {
        var nodeId = node.identifier,
            deferred = Q.defer(),
            children,
            response,
            ironAjaxEl = document.createElement('iron-ajax');
            nodeIds = {
              "001-1": "/sample-data/lotsOfChildren.json",
              "001-2": "/sample-data/deepNestedChildren.json",
              "001-2a":"/sample-data/deepNestedGrandchildren.json",
              "001-2aa": "/sample-data/deepNestedGreatGrandchild.json"
            };

        ironAjaxEl.handleAs = "json";
        ironAjaxEl.addEventListener('response', function(evt) {
          if(evt.detail.response) {
            children = evt.detail.response;
            deferred.resolve(children);
          } else {
            return;
          }
        });

        //get our url - if there's no valid nodeId, resolve an empty promise.
        if (nodeIds[nodeId]) {
          ironAjaxEl.url = nodeIds[nodeId];
          //and generate the promise.
          ironAjaxEl.generateRequest();
        } else {
          deferred.resolve({ data: [], meta: { parentId: nodeId } });
        }

        //don't forget to return the promise!
        return deferred.promise;
      }

    });
  </script>
</dom-module>
