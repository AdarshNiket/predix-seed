<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/px-context-browser/px-context-browser.html">
<link rel="import" href="../../bower_components/px-deck-selector/px-deck-selector.html">
<link rel="import" href="../../bower_components/px-card/px-dashboard.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html" />


<!-- this element loads another element and appends it to #element -->
<dom-module id="dashboards-view">

  <template>
    <iron-ajax url="/old-seed-context-data.json" last-response="{{browserContext}}" auto></iron-ajax>
    <px-context-browser
      browser-context="[[browserContext]]">
      <px-deck-selector
        decks="{{decks}}"
        selected-deck="{{selectedDeck}}"></px-deck-selector>
    </px-context-browser>
    <px-dashboard view-service-base-url="{{viewServiceBaseUrl}}" selected-deck-id="{{selectedDeck.id}}" context="{{context}}"></px-dashboard>
  </template>

  <script>
    Polymer({
      is: 'dashboards-view',
      properties: {},
      ready: function() {
        // console.log('dashboards-view', this);
        this.assignGetChildren();
      },
      assignGetChildren: function() {
        var contextBrowser = Polymer.dom(this.root).querySelector('px-context-browser');

        contextBrowser.handlers = {
          getChildren:this.getChildren,
          itemOpenHandler: this.itemOpenHandler
        };
      },
      itemOpenHandler: function(newContext) {
        console.log(newContext);
      },
      getChildren : function(node) {
        var nodeId = node.identifier,
            deferred = Q.defer(),
            children,
            response,
            ironAjaxEl = document.createElement('iron-ajax'),
            nodeIds = {
              "parent": "lotsOfChildren.json",
              "child": "deepNestedChildren.json",
              "child2":"deepNestedGrandchildren.json",
              "child3": "deepNestedGreatGrandchild.json"
            };

        ironAjaxEl.handleAs = "json";
        ironAjaxEl.addEventListener('response', function(evt) {
          if(evt.detail.response) {
           children  = evt.detail.response;
           deferred.resolve(children);
          } else {
           return;
          }
        });
        //get our url - if there's no valid nodeId, resolve an empty promise.
        if (nodeIds[nodeId]) {
            ironAjaxEl.url = nodeIds[nodeId];
            //and generate the promise.
            ironAjaxEl.generateRequest();
        } else {
          deferred.resolve({ data: [], meta: { parentId: nodeId } });
        }

        //don't forget to return the promise!
        return deferred.promise;
      }
  });
  </script>

</dom-module>
