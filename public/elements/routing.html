<!--
  We use Page.js for routing. This is a Micro client-side router inspired by the Express router
  More info: https://visionmedia.github.io/page.js/
-->
<script src="../bower_components/page/page.js"></script>
<script>
  // Setup routes for the application
  var initRouting = function() {

    // Removes end / from app.baseUrl which page.base requires for production
    if (window.location.port === '') {  // if production
        page.base(app.baseUrl.replace(/\/$/, ''));
    };

    // route middleware function to ensure that users are logged in
    var ensureLogin = function(ctx, next) {
      var pxLogin = app.$.login;
      if(pxLogin.isAuthenticated === true) {
        // user is authenticaed, go ahead!
        next();
      } else {
        // send login method call to pxLogin
        pxLogin.login(ctx);
      }
    };

    // Routes

    // Catch-all route which first runs middleware, then continue to next()
    page('*', function(ctx, next) {
      next();
    });

    page('/home', ensureLogin, function(ctx, next) {
      app.route = 'home';
    });

    page('/', ensureLogin, function() {
      app.route = 'home';
    });

    page(app.baseUrl, ensureLogin, function() {
      app.route = 'home';
    });

    page('/dashboards', ensureLogin, function() {
      app.route = 'dashboards';
    });

    page('/blank-page', function(data) {
      app.route = 'blank-page';
    });

    page('/blanksubpage', function() {
      app.route = 'blank-sub-page';
    });

    // 404
    page('*', function() {
      console.log('Route not found - 404');
      page.redirect(app.baseUrl);
    });

    // add #! before urls
    page({
      hashbang: true
    });

  };

  // Ensure webcomponents.js is loaded and ready, then initilize routing
  if(app.webComponentsReady === true) {
    initRouting();
  } else {
    window.addEventListener('WebComponentsReady', initRouting);
  };

</script>
