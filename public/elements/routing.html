<!--
  We use Page.js for routing
  Page.js is a micro client-side router inspired by the Express router
  More info: https://visionmedia.github.io/page.js/
-->
<script src="../bower_components/page/page.js"></script>
<script>
  // Setup routes for the application
  var initRouting = function() {

    // Removes end / from app.baseUrl which page.base requires for production
    if (window.location.port === '') {  // if production
        page.base(app.baseUrl.replace(/\/$/, ''));
    };

    // route middleware function to ensure that users are logged in
    var ensureLogin = function(ctx, next) {
      var pxLogin = app.$.login;
      if(pxLogin.isAuthenticated === true) {
        // user is authenticated, go ahead!
        next();
      } else {
        // send login method call to pxLogin
        pxLogin.login(ctx);
      }
    };

    // Routes

    // Catch-all route which first runs middleware, then continue to next()
    /*
    page('*', function(ctx, next) {
      console.log(ctx.path);
      next();
    });
    */
    var printPath = function(ctx, next) {
      console.log('ctx.path ', ctx.path);
      next();
    };

    // Root
    page('/', ensureLogin, printPath, function(ctx, next) {
      app.route = 'home';
      app.set('route', 'home')
      console.log(this);
    });

    // baseUrl set on index.html
    page(app.baseUrl, ensureLogin, printPath, function(ctx, next) {
      app.route = 'home';
      app.set('route', 'home');
      console.log(this);
    });

    // Dashboards (dashboards-view.html)
    page('/dashboards', ensureLogin, printPath, function(ctx, next) {
      //app.route = 'dashboards';
      app.set('route', 'dashboards')
      console.log(this);
    });

    // Blank page test (blankpage-view.html)
    page('/blankpage', printPath, function(ctx, next) {
      app.route = 'blankpage';
      app.set('route', 'blankpage');
    });

    // Blank Sub-page test (blanksubpage-view.html)
    page('/blanksubpage', printPath, function(ctx, next) {
      app.route = 'blanksubpage';
      app.set('route', 'blanksubpage');
    });

    // Blank Sub-page test (see views/blank-page)
    page('/angular', printPath, function(ctx, next) {
      app.route = 'angular';
        app.set('route', 'angular');
    });

    // 404
    page('*', function() {
      console.log('Route not found - 404');
      page.redirect(app.baseUrl);
    });

    // add #! before urls
    page({
      hashbang: true
    });

  };

  // Ensure webcomponents.js is loaded and ready, then initilize routing
  if(app.webComponentsReady === true) {
    initRouting();
  } else {
    window.addEventListener('WebComponentsReady', initRouting);
  };

</script>
