<!--
  We use Page.js for routing
  Page.js is a micro client-side router inspired by the Express router
  More info: https://visionmedia.github.io/page.js/
-->
<script src="../bower_components/page/page.js"></script>
<script>
  // Setup routes for the application
  var initRouting = function() {

    // Removes end / from app.baseUrl which page.base requires for production
    page.base(app.baseUrl.replace(/\/$/, ''));

    // route middleware function to ensure that users are logged in
    var ensureLogin = function(ctx, next) {
      var pxLogin = app.$.login;
      if(pxLogin.isAuthenticated === true) {
        // user is authenticated, go ahead!
        next();
      } else {
        // send login method call to pxLogin
        pxLogin.login(ctx);
      }
    };

    // Routes

    // Catch-all route which first runs middleware, then continue to next()
    /*
    page('*', function(ctx, next) {
      console.log(ctx.path);
      next();
    });
    */
    var printPath = function(ctx, next) {
      // console.log('routing.html ctx.path: ', ctx.path);
      next();
    };

    var getRoute = function(ctx, next) {
      // console.log('routing.html getRoute: ', app.get('route'));
    };

    // Root
    page('/', ensureLogin, printPath, function(ctx, next) {
      app.set('route', 'home');
      next();
    }, getRoute);

    // baseUrl set on index.html
    page(app.baseUrl, ensureLogin, printPath, function(ctx, next) {
      app.set('route', 'home');
      next();
    }, getRoute);

    // Dashboards (dashboards-view.html)
    page('/dashboards', ensureLogin, printPath, function(ctx, next) {
      app.set('route', 'dashboards');
      next();
    }, getRoute);

    // Blank page test (blankpage-view.html)
    page('/blankpage', printPath, function(ctx, next) {
      app.set('route', 'blankpage');
      next();
    }, getRoute);

    // Blank Sub-page test (blanksubpage-view.html)
    page('/blanksubpage', printPath, function(ctx, next) {
      app.set('route', 'blanksubpage');
      next();
    }, getRoute);

    // Blank Sub-page test (see views/blank-page)
    page('/angular', printPath, function(ctx, next) {
      app.set('route', 'angular');
      next();
    }, getRoute);

    // 404
    page('*', function() {
      // console.log('routing.html: Route not found - 404');
      page.redirect(app.baseUrl);
    });

    // add #! before urls
    page({
      hashbang: false
    });

  };

  // Ensure webcomponents.js is loaded and ready, then initilize routing
  if(app.webComponentsReady === true) {
    initRouting();
  } else {
    window.addEventListener('WebComponentsReady', initRouting);
  };

</script>
