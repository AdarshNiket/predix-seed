<link rel="import" href="../../bower_components/polymer/polymer.html">
<!-- this element does two things: -->
<!-- conditionally show/hide content -->
<!-- conditionally load content -->
<dom-module id="px-view">
  <template>
    <!-- element will be inserted here -->
  </template>
  <script>
    Polymer({

      is: 'px-view',

      properties: {
        preload: {
          type: Boolean,
          value: false
        },
        status: {
          type: String,
          observer: '_checkRoute',
          value: 'unloaded' // unloaded -> loading -> loaded -> attached
        },
        visible: {
          type: Boolean,
          observer: '_checkVisibility',
          value: false
        },
        selected: {
          type: String,
          observer: '_checkRoute',
          value: null
        },
        element: {
          type: Object,
          value: null
        },
        tag: {
          type: String,
          value: null
        },
        route: String,
        url: String
      },

      ready: function() {
        this._initializeView();
      },

      _initializeView: function() {
        if(this.tag !== null) {
          if(this.preload) {
            this._loadElement();
          };
          this._checkRoute();
        } else {
          // call back when the component is truly ready
          this.async(function() {
            this._initializeView();
          }, null, 500);
        };
      },

      _checkRoute: function() {
        // this route is selected
        if(this.route === this.selected && this.tag !== null) {
          this.visible = true;
          this._attachElement();
        };
      },

      _checkVisibility: function() {
        if(this.visible === true && this.element !== null && this.status === 'attached') {
          this.element.style.display = "block";
        } else if(this.element !== null && this.status === 'attached'){
          this.element.style.display = "none";
        }
      },

      _attachElement: function() {
        if(this.status === 'loaded') {
          this.element = document.createElement(this.tag);
          this.appendChild(this.element);
          this.status = 'attached';
          this._checkVisibility();
        } else if(this.status !== 'attached') {
          this._loadElement();
        };
      },

      _loadElement: function() {
        if(this.status === 'unloaded' && typeof this.url !== 'undefined') {
          this.importHref(this.url, function(e) {
            this.status = 'loaded';
          }, function(e) {
            console.log('failure to load ' + this.url, e);
          });
          this.status = 'loading';
        };
      }

    });
  </script>
</dom-module>
