<link rel="import" href="../bower_components/polymer/polymer.html"/>
<link rel="import" href="../bower_components/px-card/px-card.html"/>
<link rel="import" href="../bower_components/px-card/px-card-controls.html"/>
<link rel="import" href="../bower_components/px-card/px-card-behavior.html"/>
<link rel="import" href="../bower_components/px-card/px-context-name.html"/>

<dom-module id="px-tag-list">
    <template>
        <ul>Tags:
             <template is="dom-repeat" items="{{tags}}">
            <li>{{item}}</li>
            </template>
        </ul>
        <input value="{{text::input}}">
        <button on-click="addTags">Add Tags</button>
    </template>

</dom-module>
<script>
    Polymer({
        is: 'px-tag-list',
        properties: {
            tags: {
                type: Object,
                notify: true,
                observer: 'tagsChanged'
            }
        },
        addTags: function() {
            if (this.text !== '') {
                this.push('tags', this.text);
            }
            this.text = '';
        },
        tagsChanged: function(newChartState) {
            console.log('NEW TAGS', newChartState);
        },
        ready: function() {
            this.text = '';
            this.tags = [];
        }
    });
</script>

<dom-module id="px-fake-timeseries">
    <template>
        <div>FAKE TIMESERIES</div>
        <div>Min: <span>{{chartState.min}}</span></div>
        <div>Max: <span>{{chartState.max}}</span></div>
        <ul>Series displayed:
            <div>{{chartState.series}}</div>
            <!--<template is="dom-repeat" items="{{chartState.series}}">   TODO file bug for this-->
                <li>{{item}}</li>
            </template>
        </ul>
        <button on-click="zoom">Zoom</button>
    </template>

</dom-module>
<script>
    Polymer({
        is: 'px-fake-timeseries',
        properties: {
            chartState: {
                type: Object,
                notify: true,
                observer: 'chartStateChanged'
            }
        },
        zoom: function() {
            console.log('fake time series chart zoomed');
            this.chartState.min--;
            this.chartState.max++;

//            // optionally set changes individually to reflect in DOM and rollup
//            this.set('chartState.min', this.chartState.min);
//            this.set('chartState.max', this.chartState.max);
//
//            // or, aggregate all your state changes together
//            this.updateMyState();

            this.updateMyState();
        },
        chartStateChanged: function(newChartState) {
            console.log('NEW CHART STATE', newChartState);
        },
        ready: function() {
            this.text = '';
        },
        updateMyState: function() {
            this.set('chartState', {
                min: this.chartState.min,
                max: this.chartState.max,
                series: this.chartState.series
            });
        }
    });
</script>

<!--
  Steps for creating a Predix card.
    1. Create a Polymer web component.
    2. Wrap it in px-card.
    3. Use the px.cardBehavior
    4. Compose widgets and ui-elements together to create your custom card.  Implement px.cardBehavior API methods
        such as refresh and contextChanged, or call methods like getData.  -->
<dom-module id="sample-card">
    <template>
        <px-card>
            <!-- compose any widgets and ui elements you want for your card -->
            <px-card-controls></px-card-controls>
            <px-context-name context-name="{{context.name}}"></px-context-name>
            <p>This is a more complex Predix Experience card.</p>
            <button on-click="getMoreTemperatureData">Get More Temperature Data</button>
            <p id="temp">Current Temperature:<span>{{currentTemperature}}</span>F</p>
            <px-tag-list tags="{{tags}}"></px-tag-list>
            <px-fake-timeseries chart-state="{{chartState}}"></px-fake-timeseries>
            <div>-------------------------------------</div>
        </px-card>
    </template>
</dom-module>
<script>

    Polymer({
        is: 'sample-card',
        observers: ['chartStateChanged(chartState.*)', 'tagChanged(tags.*)'],
        deckStateChanged: function(newState, oldState) {
            console.log(this.id + ' new state from deck', newState);

            this.chartState = {
                min: newState.zoom.min,
                max: newState.zoom.max,
                series: newState.tags
            };

        },
        tagChanged: function(newTags){
            if (this.chartState){
                this.chartState = {
                    min: this.chartState.min,
                    max: this.chartState.max,
                    series: newTags.base
                };
            }
        },
        chartStateChanged: function(newChartState) {
            console.log(this.id + ' new chart state in sample card', newChartState);
            this.updateDeck({
                zoom: {min: newChartState.base.min, max: newChartState.base.max},
                tags: newChartState.base.series
            });
        },
        ready: function() {
            this.currentTemperature = 65;
            this.chartState = {
                series: []
            };
        },
        /**
         * (optionally) implement this API method to refresh your card data
         **/
        refresh: function() {
            console.log('refresh!');
        },
        /**
         * (optionally) implement this API method to do interesting stuff when the context is changed
         **/
        contextChanged: function(newContext, oldContext) {
            console.log('context changed!');
        },
        /**
         * add your own methods, such as this click handler, to do custom logic.
         * the px card behaviors include a getData method which will handle fetching the data for you
         **/
        getMoreTemperatureData: function() {
            var self = this;
            this.getData('/temperature').then(function(currentTemperature) {
                // on fulfillment
                self.currentTemperature = currentTemperature;
            }, function(reason) {
                // on rejection
                self.currentTemperature = 'ERROR';
            });
        },
        behaviors: [px.cardBehavior]
    });
</script>
