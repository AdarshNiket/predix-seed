<link rel="import" href="../bower_components/polymer/polymer.html"/>
<link rel="import" href="../bower_components/px-card/px-card.html"/>
<link rel="import" href="../bower_components/px-card/px-card-controls.html"/>
<link rel="import" href="../bower_components/px-card/px-card-behavior.html"/>
<link rel="import" href="../bower_components/px-card/px-context-name.html"/>

<dom-module id="px-fake-timeseries">
    <template>
        <div>FAKE TIMESERIES</div>
        <div>Min: <span>{{chartState.min}}</span></div>
        <div>Max: <span>{{chartState.max}}</span></div>
        <button on-click="zoom">Zoom</button>
    </template>

</dom-module>
<script>
    Polymer({
        is: 'px-fake-timeseries',
        properties: {
            chartState: {
                type: Object,
                notify: true,
                observer: 'chartStateChanged'
            }
        },
        zoom: function(){
            console.log('fake time series chart zoomed');
            this.chartState.min--;
            this.chartState.max++;
            //this.set('chartState.min', this.chartState.min);
//            this.set('chartState.max', this.chartState.max});
            this.set('chartState', {min: this.chartState.min, max: this.chartState.max});
        },
        chartStateChanged: function(n,old){
            console.log('fake ts new chart state  ',n);
        }
    });
</script>


<!--
  Steps for creating a Predix card.
    1. Create a Polymer web component.
    2. Wrap it in px-card.
    3. Use the px.cardBehavior
    4. Compose widgets and ui-elements together to create your custom card.  Implement px.cardBehavior API methods
        such as refresh and contextChanged, or call methods like getData.  -->
<dom-module id="sample-card">
    <template>
        <px-card>
            <!-- compose any widgets and ui elements you want for your card -->
            <px-card-controls></px-card-controls>
            <px-context-name context-name="{{context.name}}"></px-context-name>
            <p>This is a more complex Predix Experience card.</p>
            <button on-click="getMoreTemperatureData">Get More Temperature Data</button>
            <p id="temp">Current Temperature:<span>{{currentTemperature}}</span>F</p>
            <px-fake-timeseries chart-state="{{chartState}}"></px-fake-timeseries>
            <px-fake-timeseries chart-state="{{chartState}}"></px-fake-timeseries>
            <div>-------------------------------------</div>
        </px-card>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'sample-card',
        properties: {
            state: {
                type: Object,
                observer: 'stateChanged'
            }
        },
        observers: ['chartStateChanged(chartState)'],
        //coming from deck
        stateChanged: function(newState, oldState){
            console.log(this.id+' new state from deck', newState);

            this.fromDeck = true;
            // either we must set the entire object here
            this.chartState = {
                min: newState.clement.min
            };
            this.fromDeck = false;
            // or maybe we can do this if we do a deeper watch in the widget??
            //this.set('chartState.min', newState.clement.min);
        },
        //up from widget
        chartStateChanged: function(newChartState){
            if (!this.fromDeck){
                console.log(this.id+' new chart state in sample card', newChartState);
                this.updateDeck(100000);
            }
            else{
                console.log('KILL this update because from deck');
            }

        },
        updateDeck: function(value){
            if (this.findParentDeck().updateState) {
                this.findParentDeck().updateState(this.id, value);
            }
            else {
                console.log('no updatestate');
            }
        },
        findParentDeck: function(){
            var parent = this.parentElement;
            return parent;
        },
        ready: function() {
            this.currentTemperature = 65;
            this.chartState = {};
        },
        /**
         * (optionally) implement this API method to refresh your card data
         **/
        refresh: function() {
            console.log('refresh!');
        },
        /**
         * (optionally) implement this API method to do interesting stuff when the context is changed
         **/
        contextChanged: function(newContext, oldContext) {
            console.log('context changed!');
        },
        /**
         * add your own methods, such as this click handler, to do custom logic.
         * the px card behaviors include a getData method which will handle fetching the data for you
         **/
        getMoreTemperatureData: function(){
            var self = this;
            this.getData('/temperature').then(function(currentTemperature) {
                // on fulfillment
                self.currentTemperature = currentTemperature;
            }, function(reason) {
                // on rejection
                self.currentTemperature = 'ERROR';
            });
        },
        behaviors: [px.cardBehavior]
    });
</script>
